# mcpwall recipe for shell/terminal MCP servers
# Use with any MCP server that executes shell commands (e.g. mcp-shell, mcp-run-python).
# Blocks network commands, package installs, and common attack patterns.
# default_action is allow â€” changing to deny would break all shell usage.
version: 1

settings:
  log_dir: ~/.mcpwall/logs
  log_level: info
  default_action: allow

rules:
  # === CORE PROTECTIONS (same as local-dev) ===
  - name: block-destructive-commands
    match:
      method: tools/call
      tool: "*"
      arguments:
        _any_value:
          regex: "(rm\\s+-r|rm\\s+-f|rmdir\\s+/|mkfs|dd\\s+if=|format\\s+[A-Z]:)"
    action: deny
    message: "Blocked: destructive shell command"

  - name: block-pipe-to-shell
    match:
      method: tools/call
      tool: "*"
      arguments:
        _any_value:
          regex: "(curl|wget|fetch).*\\|.*(bash|sh|zsh|python|node)"
    action: deny
    message: "Blocked: piping remote content to shell"

  - name: block-reverse-shells
    match:
      method: tools/call
      tool: "*"
      arguments:
        _any_value:
          regex: "(nc\\s+-[le]|/dev/tcp/|bash\\s+-i\\s+>&|mkfifo|socat)"
    action: deny
    message: "Blocked: potential reverse shell"

  # === SHELL-SPECIFIC ADDITIONS ===
  # Block outbound network commands that could exfiltrate data
  - name: block-network-commands
    match:
      method: tools/call
      tool: "*"
      arguments:
        _any_value:
          regex: "(curl|wget|nc|ncat|socat|ssh|scp|rsync)\\s"
    action: deny
    message: "Blocked: network command in shell (use dedicated MCP tools for network access)"

  # Block package manager installs (prevents supply chain attacks)
  - name: block-package-install
    match:
      method: tools/call
      tool: "*"
      arguments:
        _any_value:
          regex: "(npm install|pip install|apt install|brew install|yarn add|gem install|cargo install)"
    action: deny
    message: "Blocked: package installation via shell"

  # === SECRET LEAKAGE ===
  - name: block-secret-leakage
    match:
      method: tools/call
      tool: "*"
      arguments:
        _any_value:
          secrets: true
    action: deny
    message: "Blocked: detected secret/API key in shell command"

outbound_rules:
  - name: redact-secrets-in-responses
    match:
      secrets: true
    action: redact
    message: "Secret detected in shell output and redacted"

  - name: flag-shell-patterns-in-output
    match:
      response_contains_regex:
        - "rm\\s+-rf\\s+/"
        - "curl.*\\|.*bash"
        - "wget.*\\|.*sh"
    action: log_only
    message: "Shell command pattern in output"

secrets:
  patterns:
    - name: aws-access-key
      regex: "AKIA[0-9A-Z]{16}"
    - name: github-token
      regex: "(gh[ps]_[A-Za-z0-9_]{36,}|github_pat_[A-Za-z0-9_]{22,})"
    - name: private-key-header
      regex: "-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----"
    - name: database-url
      regex: "(postgres|mysql|mongodb|redis)://[^\\s]+"
